<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Carrinho - Feira Escolar</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header style="background: var(--cor-amarelo); padding: 12px 20px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
    <div style="display: flex; align-items: center; gap: 12px;">
      <img src="https://firebasestorage.googleapis.com/v0/b/feira-escolar-2025.firebasestorage.app/o/produtos%2Fcapa.png?alt=media"
           alt="Logo Feira Escolar"
           style="height: 64px; width: auto; border-radius: 4px;">
      <span id="titulo-pagina" style="font-size: 1.2rem; font-weight: bold; color: var(--cor-principal); font-family: var(--fonte-titulo);" onclick="window.location.href='index.html'" style="cursor:pointer;">
        Feira Escolar 2025
      </span>
    </div>

    <div style="flex: 1; max-width: 500px; margin: 0 20px;">
      <input type="text" id="busca-produtos" placeholder="Buscar produtos..." disabled
             style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 1rem;">
    </div>

    <nav style="display: flex; align-items: center; gap: 20px; position: relative;">
      
      <div class="menu-container" style="position: relative;">
        <button id="btn-categorias" class="btn-acao" style="background: var(--cor-principal); color: white; padding: 10px; border-radius: 50%; border: none; font-weight: bold; cursor: pointer; display: none;">
          ‚ò∞
        </button>
        <div id="menu-categorias" class="menu-dropdown" style="display: none; position: absolute; top: 45px; left: 0; background: white; border: 1px solid #eee; border-radius: 6px; z-index: 10; min-width: 150px; box-shadow: var(--sombra);">
          </div>
      </div>
      
      <a href="vender.html" class="btn-acao">
        Vender
      </a>

      <a href="carrinho.html" class="btn-acao" style="position: relative;">
        üõí Carrinho
        <span id="qtd-carrinho"
              style="position: absolute; top: -8px; right: -12px; background: red; color: white; border-radius: 50%; padding: 2px 6px; font-size: 0.75rem; font-weight: bold;">
          0
        </span>
      </a>

      <div id="usuario-container" style="position: relative; cursor: pointer; display: flex; align-items: center; gap: 8px;">
        <span id="nome-usuario" style="font-weight: 600; color: var(--cor-principal);">Convidado</span>
        <div id="menu-usuario" class="menu-dropdown" style="display: none; position: absolute; top: 45px; right: 0; background: white; border: 1px solid #eee; border-radius: 6px; z-index: 10; min-width: 150px; box-shadow: var(--sombra);">
          </div>
      </div>
    </nav>
  </header>

  <main>
    <div class="container" id="carrinho-container">
      <p class="carregando">Carregando carrinho...</p>
    </div>

    <div id="botoes" class="container">
      <button onclick="window.location.href='index.html'" style="background-color: #f0f0f0;">‚Üê Continuar Comprando</button>
      <button id="btn-limpar" onclick="limparCarrinho()">Limpar Carrinho</button>
      <button id="btn-finalizar">Finalizar Compra</button>
    </div>
  </main>

  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="app.js"></script>

  <script>
    // Fun√ß√µes utilit√°rias do cabe√ßalho
    function atualizarQtdCarrinho() {
      const carrinho = JSON.parse(localStorage.getItem('carrinho-feira')) || [];
      const totalItens = carrinho.reduce((acc, item) => acc + item.quantidade, 0);
      document.getElementById('qtd-carrinho').textContent = totalItens;
    }

    function atualizarNomeUsuario() {
      const container = document.getElementById('usuario-container');
      const nomeEl = document.getElementById('nome-usuario');
      const menu = document.getElementById('menu-usuario');
      const nome = sessionStorage.getItem('aluno_logado');

      if (nome) {
        nomeEl.textContent = nome.length > 10 ? nome.split(' ')[0] : nome;
        container.style.cursor = 'pointer';
        menu.innerHTML = `
          <div style="padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #eee;" onclick="alert('Minha Conta: ${nome}')">
            üë§ Minha Conta
          </div>
          <div style="padding: 8px 12px; cursor: pointer;" onclick="sessionStorage.removeItem('aluno_logado'); alert('‚úÖ Voc√™ saiu.'); location.reload();">
            üö™ Sair
          </div>
        `;
      } else {
        nomeEl.textContent = 'Convidado';
        container.style.cursor = 'pointer';
        menu.innerHTML = `
          <div style="padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #eee;" onclick="document.getElementById('menu-usuario').style.display='none';">
            Continuar como convidado
          </div>
          <div style="padding: 8px 12px; cursor: pointer;" onclick="window.location.href='login.html'">
            Fazer login
          </div>
        `;
      }
    }

    // Adiciona os listeners de clique para abrir/fechar menus
    document.getElementById('usuario-container')?.addEventListener('click', function(e) {
      e.stopPropagation();
      const menu = document.getElementById('menu-usuario');
      menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    });

    document.getElementById('btn-categorias')?.addEventListener('click', function(e) {
      e.stopPropagation();
      const menu = document.getElementById('menu-categorias');
      menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    });


    // L√≥gica do Carrinho
    let carrinho = JSON.parse(localStorage.getItem('carrinho-feira')) || [];
    const container = document.getElementById('carrinho-container');

    function atualizarCarrinho() {
      carrinho = JSON.parse(localStorage.getItem('carrinho-feira')) || [];

      if (carrinho.length === 0) {
        container.innerHTML = '<h2>Seu carrinho est√° vazio</h2><p>Adicione produtos na <a href="index.html">loja</a>!</p>';
        document.getElementById('btn-finalizar').disabled = true;
        return;
      }
      document.getElementById('btn-finalizar').disabled = false;
      let total = 0;
      let html = '<h2>Itens no carrinho:</h2>';
      carrinho.forEach((item, index) => {
        const subtotal = item.preco * item.quantidade;
        total += subtotal;
        html += `
          <div class="item-carrinho">
            <div>
                <strong>${item.nome}</strong><br>
                R$ ${item.preco.toFixed(2)} √ó ${item.quantidade} = R$ ${subtotal.toFixed(2)}
            </div>
            <button onclick="removerItem(${index})">Remover</button>
          </div>
        `;
      });
      html += `<div class="total">Total: R$ ${total.toFixed(2)}</div>`;
      container.innerHTML = html;
    }

    function removerItem(index) {
      carrinho.splice(index, 1);
      localStorage.setItem('carrinho-feira', JSON.stringify(carrinho));
      atualizarCarrinho();
      atualizarQtdCarrinho();
    }

    function limparCarrinho() {
      if (confirm('Tem certeza que deseja limpar o carrinho?')) {
        carrinho = [];
        localStorage.removeItem('carrinho-feira');
        atualizarCarrinho();
        atualizarQtdCarrinho();
      }
    }

    // L√≥gica de Finalizar Compra (com transa√ß√£o)
    function finalizarCompra() {
      if (!confirm('Deseja realmente finalizar a compra? O estoque ser√° atualizado.')) return;

      if (carrinho.length === 0) {
        alert('Seu carrinho est√° vazio.');
        return;
      }
      
      const pedido = {
        data: firebase.firestore.FieldValue.serverTimestamp(),
        comprador: sessionStorage.getItem('aluno_logado') || 'Convidado',
        itens: carrinho.map(item => ({
          id: item.id,
          nome: item.nome,
          preco: item.preco,
          quantidade: item.quantidade
        })),
        total: carrinho.reduce((acc, item) => acc + item.preco * item.quantidade, 0),
        status: 'Pendente' 
      };

      try {
        db.runTransaction(async (transaction) => {
          const updates = [];

          for (const item of carrinho) {
            const produtoRef = db.collection('produtos').doc(item.id);
            updates.push(produtoRef);
          }

          const docs = await transaction.getAll(...updates);

          for (let i = 0; i < docs.length; i++) {
            const doc = docs[i];
            const item = carrinho[i];
            const estoqueAtual = doc.data()?.estoque || 0;

            if (estoqueAtual < item.quantidade) {
              throw new Error(`Estoque insuficiente para "${item.nome}". Apenas ${estoqueAtual} unid. dispon√≠vel(eis).`);
            }

            transaction.update(doc.ref, {
              estoque: estoqueAtual - item.quantidade,
              vendas: firebase.firestore.FieldValue.increment(item.quantidade)
            });
          }

          await db.collection('pedidos').add(pedido);

        }).then(() => {
          localStorage.removeItem('carrinho-feira');
          atualizarQtdCarrinho();
          alert('‚úÖ Compra finalizada com sucesso! Seu pedido foi registrado.');
          window.location.href = 'index.html';

        }).catch((error) => {
          alert('‚ùå Erro ao processar a compra: ' + error.message);
        });

      } catch (err) {
        alert('‚ùå Erro inesperado: ' + err.message);
      }
    }

    document.getElementById('btn-finalizar').onclick = finalizarCompra;

    // Chamadas iniciais
    window.addEventListener('load', () => {
      atualizarNomeUsuario();
      atualizarQtdCarrinho();
      atualizarCarrinho();
    });
  </script>
</body>
</html>