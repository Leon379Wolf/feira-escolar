<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Carrinho - Feira Escolar</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header>
    <a href="index.html" class="btn-link">‚Üê Voltar √† loja</a>
    <div style="display:flex; align-items:center; gap:20px;">
        <span id="saudacao" style="font-weight:600; color:white;">Ol√°, Convidado</span>
        <div id="login-link" style="color:white;"><a href="login.html">Entrar</a></div>
    </div>
  </header>

  <main>
    <section class="carrinho-header">
        <h1>üõí Meu Carrinho</h1>
        <div class="carrinho-info">
            <p>Total: <strong id="total-carrinho">R$ 0,00</strong></p> 
            <button onclick="limparCarrinho()" class="btn-limpar">Limpar Carrinho</button>
        </div>
    </section>

    <div id="carrinho-container" class="carrinho-itens">
        <p class="carrinho-vazio">Seu carrinho est√° vazio.</p>
    </div>

    <div class="carrinho-footer">
        <p id="erro" class="mensagem-erro"></p> <button id="btn-finalizar" class="btn-finalizar" disabled>
            Finalizar Compra
        </button>
    </div>

    <div style="text-align: center; margin-top: 15px;">
        <a href="index.html" style="color: #666;">‚Üê Voltar √† Loja</a>
    </div>
  </main>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="app.js"></script>

  <script>
    // --- FUN√á√ïES DE UTILIDADE ---
    function atualizarNomeUsuario() {
        const nomeUsuario = sessionStorage.getItem('aluno_logado');
        const saudacaoEl = document.getElementById('saudacao');
        const loginLink = document.getElementById('login-link');

        if (nomeUsuario && saudacaoEl && loginLink) {
            saudacaoEl.textContent = nomeUsuario === 'admin' 
                ? 'Ol√°, Admin (Vendedor)' 
                : `Ol√°, ${nomeUsuario} (Vendedor)`;
            
            loginLink.innerHTML = `<a href="#" onclick="fazerLogout()">Sair</a>`;
        }
    }

    function fazerLogout() {
        sessionStorage.removeItem('aluno_logado');
        window.location.href = 'login.html';
    }

    function atualizarQtdCarrinho() {
        const carrinho = JSON.parse(localStorage.getItem('carrinho-feira')) || [];
        const qtdEl = document.getElementById('carrinho-qtd');
        if (qtdEl) {
            qtdEl.textContent = carrinho.length;
        }
    }

    // --- L√ìGICA DO CARRINHO E COMPRA ---
    let carrinho = JSON.parse(localStorage.getItem('carrinho-feira')) || [];
    const container = document.getElementById('carrinho-container');

    function atualizarCarrinho() {
        // FIX: Acessa os elementos do footer/header antes de us√°-los
        const totalCarrinhoEl = document.getElementById('total-carrinho');
        const btnFinalizarEl = document.getElementById('btn-finalizar');

        container.innerHTML = '';
        if (carrinho.length === 0) {
            container.innerHTML = '<p class="carrinho-vazio">Seu carrinho est√° vazio.</p>';
            if (totalCarrinhoEl) totalCarrinhoEl.textContent = 'R$ 0,00';
            if (btnFinalizarEl) btnFinalizarEl.disabled = true;
            return;
        }

        let totalGeral = 0;
        if (btnFinalizarEl) btnFinalizarEl.disabled = false;

        carrinho.forEach((item, index) => {
            const totalItem = item.preco * item.quantidade;
            totalGeral += totalItem;

            const itemHTML = `
                <div class="carrinho-item">
                    <div class="item-detalhes">
                        <h3>${item.nome}</h3>
                        <p>R$ ${item.preco.toFixed(2)} x ${item.quantidade} un.</p>
                    </div>
                    <div class="item-total">
                        R$ ${totalItem.toFixed(2)}
                        <button onclick="removerItem(${index})">Remover</button>
                    </div>
                </div>
            `;
            container.innerHTML += itemHTML;
        });

        if (totalCarrinhoEl) totalCarrinhoEl.textContent = `R$ ${totalGeral.toFixed(2)}`;
    }

    function removerItem(index) {
        carrinho.splice(index, 1);
        localStorage.setItem('carrinho-feira', JSON.stringify(carrinho));
        atualizarQtdCarrinho();
        atualizarCarrinho();
    }

    function limparCarrinho() {
        if (confirm('Tem certeza que deseja limpar todo o carrinho?')) {
            carrinho = [];
            localStorage.removeItem('carrinho-feira');
            atualizarQtdCarrinho();
            atualizarCarrinho();
        }
    }


    // FIX CR√çTICO: Fun√ß√£o Finalizar Compra com Transa√ß√£o Correta
    function finalizarCompra() {
        const nomeVendedor = sessionStorage.getItem('aluno_logado');
        // FIX: Garante que o elemento 'erro' existe
        const erroEl = document.getElementById('erro'); 
        if (erroEl) erroEl.textContent = ''; // Limpa erro anterior

        if (!nomeVendedor) {
            if (erroEl) erroEl.textContent = 'Voc√™ deve estar logado para finalizar a compra.';
            return;
        }

        if (carrinho.length === 0) {
            if (erroEl) erroEl.textContent = 'O carrinho est√° vazio.';
            return;
        }

        if (typeof db === 'undefined') {
            if (erroEl) erroEl.textContent = '‚ùå Erro: Firebase n√£o carregado. Verifique a conex√£o.';
            return;
        }

        const estoqueRef = db.collection('produtos'); // Usamos 'produtos' para estoque
        const vendasRef = db.collection('vendas');

        // 1. Mapeia os itens do carrinho para refer√™ncias de documentos de estoque
        const itemsParaTransacao = carrinho.map(item => ({
            ref: estoqueRef.doc(item.id),
            quantidadeComprada: item.quantidade,
            nomeProduto: item.nome
        }));

        db.runTransaction(async (transaction) => {
            // 2. Obt√©m todas as informa√ß√µes de estoque DENTRO da transa√ß√£o
            // Usa Promise.all() para buscar todos os documentos de estoque de uma vez (FIX: Usando transaction.get)
            const getPromises = itemsParaTransacao.map(item => transaction.get(item.ref));
            const snapshots = await Promise.all(getPromises);

            // 3. Verifica o estoque e prepara as atualiza√ß√µes
            for (let i = 0; i < snapshots.length; i++) {
                const snapshot = snapshots[i];
                const itemTransacao = itemsParaTransacao[i];
                const data = snapshot.data();

                if (!snapshot.exists) {
                    throw new Error(`O produto "${itemTransacao.nomeProduto}" n√£o existe no estoque.`);
                }

                const estoqueAtual = data.estoque; // Campo no Firestore √© 'estoque'
                const novoEstoque = estoqueAtual - itemTransacao.quantidadeComprada;

                if (novoEstoque < 0) {
                    throw new Error(`Estoque insuficiente para "${itemTransacao.nomeProduto}". Dispon√≠vel: ${estoqueAtual}`);
                }

                // 4. Aplica a atualiza√ß√£o de estoque
                transaction.update(itemTransacao.ref, {
                    estoque: novoEstoque // Atualiza o campo 'estoque'
                });
            }

            // 5. Registra o pedido de venda
            const pedido = {
                vendedor: nomeVendedor,
                data: firebase.firestore.FieldValue.serverTimestamp(),
                // Pega o total do elemento que foi atualizado
                total: parseFloat(document.getElementById('total-carrinho')?.textContent?.replace('R$ ', '').replace(',', '.') || '0'), 
                itens: carrinho.map(item => ({
                    id: item.id,
                    nome: item.nome,
                    preco: item.preco,
                    quantidade: item.quantidade
                }))
            };

            // Adiciona o pedido √† cole√ß√£o 'vendas'
            return transaction.set(vendasRef.doc(), pedido);

        }).then(() => {
            // Sucesso
            localStorage.removeItem('carrinho-feira');
            atualizarQtdCarrinho();
            alert('‚úÖ Compra finalizada com sucesso! Seu pedido foi registrado.');
            window.location.href = 'index.html';
        }).catch((error) => {
            // Falha 
            const msgErro = `‚ùå Erro ao processar a compra: ${error.message}`;
            if (erroEl) erroEl.textContent = msgErro;
            console.error('Erro na transa√ß√£o de compra:', error);
        });
    }

    // Listener para o bot√£o de finalizar
    const btnFinalizar = document.getElementById('btn-finalizar');
    if (btnFinalizar) {
        btnFinalizar.onclick = finalizarCompra;
    }


    // --- CHAMADAS INICIAIS ---
    window.addEventListener('load', () => {
        atualizarNomeUsuario();
        atualizarQtdCarrinho();
        atualizarCarrinho();
    });
  </script>
</body>
</html>
