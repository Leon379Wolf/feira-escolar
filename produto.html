<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Detalhes do Produto - Feira Escolar</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header style="background: var(--cor-amarelo); padding: 12px 20px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
    <div style="display: flex; align-items: center; gap: 12px;">
      <img src="https://firebasestorage.googleapis.com/v0/b/feira-escolar-2025.firebasestorage.app/o/produtos%2Fcapa.png?alt=media"
           alt="Logo Feira Escolar"
           style="height: 64px; width: auto; border-radius: 4px;">
      <span id="titulo-pagina" style="font-size: 1.2rem; font-weight: bold; color: var(--cor-principal); font-family: var(--fonte-titulo);" onclick="window.location.href='index.html'" style="cursor:pointer;">
        Feira Escolar 2025
      </span>
    </div>

    <div style="flex: 1; max-width: 500px; margin: 0 20px;">
      <input type="text" id="busca-produtos" placeholder="Buscar produtos..." disabled
             style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 1rem;">
    </div>

    <nav style="display: flex; align-items: center; gap: 20px; position: relative;">
      
      <div class="menu-container" style="position: relative;">
        <button id="btn-categorias" class="btn-acao" style="background: var(--cor-principal); color: white; padding: 10px; border-radius: 50%; border: none; font-weight: bold; cursor: pointer; display: none;">
          ‚ò∞
        </button>
        <div id="menu-categorias" class="menu-dropdown" style="display: none; position: absolute; top: 45px; left: 0; background: white; border: 1px solid #eee; border-radius: 6px; z-index: 10; min-width: 150px; box-shadow: var(--sombra);">
          </div>
      </div>
      
      <a href="vender.html" class="btn-acao">
        Vender
      </a>

      <a href="carrinho.html" class="btn-acao" style="position: relative;">
        üõí Carrinho
        <span id="qtd-carrinho"
              style="position: absolute; top: -8px; right: -12px; background: red; color: white; border-radius: 50%; padding: 2px 6px; font-size: 0.75rem; font-weight: bold;">
          0
        </span>
      </a>

      <div id="usuario-container" style="position: relative; cursor: pointer; display: flex; align-items: center; gap: 8px;">
        <span id="nome-usuario" style="font-weight: 600; color: var(--cor-principal);">Convidado</span>
        <div id="menu-usuario" class="menu-dropdown" style="display: none; position: absolute; top: 45px; right: 0; background: white; border: 1px solid #eee; border-radius: 6px; z-index: 10; min-width: 150px; box-shadow: var(--sombra);">
          </div>
      </div>
    </nav>
  </header>

  <main>
    <div class="container" id="detalhes-produto">
      <p class="carregando">Carregando detalhes do produto...</p>
      </div>
  </main>
  
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>
  <script src="app.js"></script>

  <script>
    // Fun√ß√µes utilit√°rias do cabe√ßalho
    function atualizarQtdCarrinho() {
      const carrinho = JSON.parse(localStorage.getItem('carrinho-feira')) || [];
      const totalItens = carrinho.reduce((acc, item) => acc + item.quantidade, 0);
      document.getElementById('qtd-carrinho').textContent = totalItens;
    }

    function atualizarNomeUsuario() {
      const container = document.getElementById('usuario-container');
      const nomeEl = document.getElementById('nome-usuario');
      const menu = document.getElementById('menu-usuario');
      const nome = sessionStorage.getItem('aluno_logado');

      if (nome) {
        nomeEl.textContent = nome.length > 10 ? nome.split(' ')[0] : nome;
        container.style.cursor = 'pointer';
        menu.innerHTML = `
          <div style="padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #eee;" onclick="alert('Minha Conta: ${nome}')">
            üë§ Minha Conta
          </div>
          <div style="padding: 8px 12px; cursor: pointer;" onclick="sessionStorage.removeItem('aluno_logado'); alert('‚úÖ Voc√™ saiu.'); location.reload();">
            üö™ Sair
          </div>
        `;
      } else {
        nomeEl.textContent = 'Convidado';
        container.style.cursor = 'pointer';
        menu.innerHTML = `
          <div style="padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #eee;" onclick="document.getElementById('menu-usuario').style.display='none';">
            Continuar como convidado
          </div>
          <div style="padding: 8px 12px; cursor: pointer;" onclick="window.location.href='login.html'">
            Fazer login
          </div>
        `;
      }
    }

    // Adiciona os listeners de clique para abrir/fechar menus
    document.getElementById('usuario-container')?.addEventListener('click', function(e) {
      e.stopPropagation();
      const menu = document.getElementById('menu-usuario');
      menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    });

    document.getElementById('btn-categorias')?.addEventListener('click', function(e) {
      e.stopPropagation();
      const menu = document.getElementById('menu-categorias');
      menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    });


    // L√≥gica para carregar o produto
    async function carregarDetalhesProduto() {
      const urlParams = new URLSearchParams(window.location.search);
      const produtoId = urlParams.get('id');
      const container = document.getElementById('detalhes-produto');

      if (!produtoId) {
        container.innerHTML = '<p class="carregando">‚ùå Produto n√£o especificado.</p>';
        return;
      }

      try {
        const doc = await db.collection('produtos').doc(produtoId).get();

        if (!doc.exists) {
          container.innerHTML = '<p class="carregando">‚ùå Produto n√£o encontrado.</p>';
          return;
        }

        const p = doc.data();
        const estaEsgotado = p.estoque <= 0;

        const estoqueMsg = estaEsgotado
          ? `<span class="estoque-msg esgotado">‚ùå Esgotado</span>`
          : `<span class="estoque-msg">üì¶ Dispon√≠vel: ${p.estoque} unid.</span>`;

        const adminBotoes = ehAdmin() ?
          `<button class="btn-excluir" onclick="excluirProduto('${doc.id}')" style="margin-right: 15px;">Excluir Produto</button>` : '';
        
        const botaoCarrinho = estaEsgotado 
            ? `<button class="btn-carrinho" disabled style="background-color: #ccc; cursor: not-allowed; flex:1;">Esgotado</button>`
            : `<button class="btn-carrinho" onclick="adicionarAoCarrinho('${doc.id}', '${p.nome}', ${p.preco}, ${p.estoque})">
                üõí Adicionar ao Carrinho
              </button>`;
        
        container.innerHTML = `
          <div class="detalhes-container">
            <div class="imagem-grande">
              <img src="${p.imagem || 'data:image/svg+xml,<svg xmlns=&quot;http://www.w3.org/2000/svg&quot; width=&quot;100&quot; height=&quot;100&quot;><rect width=&quot;100&quot; height=&quot;100&quot; fill=&quot;%23f0f0f0&quot;/></svg>'}" alt="${p.nome}">
            </div>
            <div class="info-produto">
              <h1>${p.nome}</h1>
              <p class="preco-grande">R$ ${p.preco.toFixed(2)}</p>

              <div class="info-item"><strong>Vendedor:</strong> ${p.vendedor}</div>
              <div class="info-item"><strong>Departamento:</strong> ${p.departamento}</div>
              <div class="info-item">${estoqueMsg}</div>

              <p style="margin-top: 15px;">${p.descricao || 'Sem descri√ß√£o detalhada.'}</p>

              <div class="botoes-detalhes">
                ${adminBotoes}
                ${botaoCarrinho}
                <a href="carrinho.html" class="btn-comprar">Comprar Agora</a>
              </div>

              <div class="avaliacoes-secao">
                <h3>Avalia√ß√µes</h3>
                <p>O formul√°rio de avalia√ß√£o deve ser implementado para salvar no Firebase.</p>
              </div>
            </div>
          </div>

          <div class="relacionados-secao">
            <h3>Produtos Relacionados</h3>
            <div id="produtos-relacionados" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px;">
              </div>
          </div>
        `;
        carregarRelacionados(p.departamento, doc.id);

      } catch (err) {
        console.error("Erro ao carregar produto:", err);
        container.innerHTML = '<p class="carregando">‚ùå Ocorreu um erro ao carregar os detalhes do produto.</p>';
      }
    }

    async function carregarRelacionados(departamento, produtoExcluidoId) {
      const container = document.getElementById('produtos-relacionados');
      let count = 0;

      try {
        const snapshot = await db.collection('produtos')
          .where('departamento', '==', departamento)
          .limit(5)
          .get();

        snapshot.forEach(doc => {
          if (doc.id === produtoExcluidoId) return;
          const p = doc.data();
          
          const card = document.createElement('div');
          card.style = "background: var(--cor-card); border: 1px solid #eee; border-radius: var(--raio-borda); padding: 8px; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.05);";
          card.innerHTML = `
            <a href="produto.html?id=${doc.id}" style="text-decoration:none; color:inherit;">
              <img src="${p.imagem || 'data:image/svg+xml,<svg xmlns=&quot;http://www.w3.org/2000/svg&quot; width=&quot;100&quot; height=&quot;100&quot;><rect width=&quot;100&quot; height=&quot;100&quot; fill=&quot;%23f0f0f0&quot;/></svg>'}"
                   alt="${p.nome}" style="width:100%; height:auto; max-height:100px; object-fit:contain; background:#f9f9f9; padding:10px 0; box-sizing:border-box; border-radius:6px;">
              <div style="font-weight:bold; margin:6px 0;">R$ ${p.preco?.toFixed(2) || '0,00'}</div>
              <div style="font-size:0.9rem; color:#666;">${p.nome?.substring(0, 20)}${p.nome?.length > 20 ? '...' : ''}</div>
            </a>
          `;
          container.appendChild(card);
          count++;
        });

        if (count === 0) {
          container.innerHTML = '<p style="grid-column:1/-1; text-align:center; color:#888;">Nenhum produto relacionado.</p>';
        }

      } catch (err) {
        console.error("Erro ao carregar relacionados:", err);
        container.innerHTML = '<p style="grid-column:1/-1; text-align:center; color:#888;">Erro ao carregar relacionados.</p>';
      }
    }

    window.addEventListener('load', () => {
        atualizarNomeUsuario();
        atualizarQtdCarrinho();
        carregarDetalhesProduto();
    });
  </script>
</body>
</html>